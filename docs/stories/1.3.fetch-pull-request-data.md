# Story 1.3: Fetch Pull Request Data

## Status
✅ **DEPLOYED TO PRODUCTION**

## Story
**As a** reviewer,
**I want** to provide a GitHub PR URL to the service,
**so that** it can fetch the relevant code and metadata for the simulation.

## Acceptance Criteria
1. An authenticated user can submit a PR URL to a specific endpoint.
2. The service uses the GitHub API to fetch details of the PR.
3. Within a persistent local clone of the repository, the service successfully checks out the specific branch for the pull request.

## Tasks / Subtasks
- [x] Create PR data models and validation (AC: 1, 2)
  - [x] Create PullRequest model with GitHub PR metadata structure
  - [x] Create PR URL validation and parsing logic
  - [x] Add request/response models for PR submission endpoint
- [x] Implement PR submission API endpoint (AC: 1)
  - [x] Create POST /simulations endpoint with authentication middleware
  - [x] Validate PR URL format and extract owner/repo/pull_number
  - [x] Create SimulationJob record in DynamoDB with pending status
  - [x] Return job_id to client for tracking
- [x] Extend GitHub service for PR data fetching (AC: 2)
  - [x] Add get_pull_request method to fetch PR details from GitHub API
  - [x] Add get_pull_request_diff method to fetch code changes
  - [x] Implement proper error handling for invalid PRs or API failures
  - [x] Add rate limiting considerations for GitHub API calls
- [x] Implement repository management service (AC: 3)
  - [x] Create repository service for local git operations
  - [x] Implement persistent local repository cloning logic
  - [x] Add branch checkout functionality for PR branches
  - [x] Handle repository updates and cleanup operations
- [x] Add comprehensive unit tests (Testing Standards)
  - [x] Test PR URL validation and parsing
  - [x] Test PR submission endpoint with valid/invalid URLs
  - [x] Test GitHub API integration with mocked responses
  - [x] Test repository cloning and branch checkout operations
  - [x] Test error handling for network failures and invalid repositories
- [x] Update infrastructure configuration
  - [x] Add file system permissions for repository storage in Lambda
  - [x] Configure temporary storage location for repository clones
  - [x] Update IAM policies for any additional AWS service access

## Dev Notes

### Previous Story Insights
From Story 1.2: GitHub OAuth2 authentication system fully implemented with comprehensive security features. GitHub service component exists and is ready for extension. User authentication middleware operational for protecting endpoints. DynamoDB user storage and JWT session management working properly.

### Data Models
**SimulationJob Model** [Source: architecture/data-models.md#simulationjob]:
- **Purpose**: Track the state, progress, and results of a single PR simulation request from start to finish
- **Key Attributes**: `job_id`, `user_id`, `pr_url`, `status`, `report`, `created_at`, `completed_at`
- **Relationships**: Belongs to a User
- **Status Values**: pending, running, completed, failed

**PullRequest Model** (New - derived from GitHub API structure):
- **Purpose**: Store GitHub PR metadata and diff information for simulation processing
- **Key Attributes**: `owner`, `repo`, `pull_number`, `title`, `head_sha`, `base_sha`, `head_ref`, `base_ref`, `diff_url`, `patch_url`
- **Source**: GitHub API `/repos/{owner}/{repo}/pulls/{pull_number}` response structure

### API Specifications
**Simulation Endpoints** [Source: architecture/rest-api-spec.md]:
- **POST /simulations**: Submit new simulation job
  - **Request Body**: `{"pr_url": "https://github.com/owner/repo/pull/123"}`
  - **Response**: `{"job_id": "uuid"}` with 202 status
  - **Authentication**: Requires Bearer JWT token
  - **Error Responses**: 400 for invalid PR URL, 401 for unauthenticated, 500 for server errors

**GitHub API Integration** [Source: architecture/external-apis.md#github-api]:
- **GET /repos/{owner}/{repo}/pulls/{pull_number}**: Fetch PR details and metadata
- **Authentication**: OAuth2 using user's stored access token
- **Rate Limits**: 5,000 requests per hour for authenticated requests
- **Required Scope**: `repo` scope for accessing repository data

### Database Schema
**DynamoDB Table Structure** [Source: architecture/database-schema.md#table]:
- **Table Name**: `myfav-coworker-main`
- **SimulationJob Items**:
  - **Partition Key (PK)**: `JOB#{job_id}`
  - **Sort Key (SK)**: `METADATA`
  - **GSI**: Query jobs by user using `USER#{github_id}` index

### File Locations
Based on project structure [Source: architecture/source-tree.md]:
- **API Endpoints**: `src/api/simulations.py` for new simulation endpoints
- **Repository Service**: `src/services/repository_service.py` for git operations
- **PR Models**: `src/models/pull_request.py` for GitHub PR data structures
- **Job Models**: `src/models/simulation_job.py` for simulation tracking
- **Tests**: `tests/unit/` directory mirroring source structure

### Technical Constraints
**Technology Stack** [Source: architecture/tech-stack.md]:
- **Data Validation**: Pydantic 2.7+ for PR URL validation and GitHub API response parsing
- **Database**: AWS DynamoDB for simulation job tracking
- **Git Operations**: Use Python `git` library or subprocess calls for repository management
- **File System**: Lambda temporary storage (`/tmp`) for repository clones (512MB limit)

**External API Integration** [Source: architecture/external-apis.md#github-api]:
- **GitHub Service**: All GitHub API interactions must be encapsulated in GitHub Service component
- **Error Handling**: Proper handling of GitHub API rate limits and network failures
- **Authentication**: Use encrypted user access tokens from previous authentication flow

### Repository Management Requirements
**Local Repository Strategy**:
- **Storage Location**: Use Lambda `/tmp` directory for temporary repository storage
- **Persistence**: Repositories should be cloned fresh for each simulation to ensure clean state
- **Branch Management**: Checkout specific PR branch using `git checkout` commands
- **Cleanup**: Implement proper cleanup of repository files after simulation completion
- **Size Limits**: Consider repository size limits within Lambda storage constraints

### Testing
**Testing Standards** [Source: architecture/test-strategy-and-standards.md]:
- **Framework**: pytest with unittest.mock for unit tests
- **Coverage Goal**: 80% line coverage minimum
- **Integration Testing**: Use moto library to mock AWS services locally
- **Test Organization**: Tests located in `tests/unit/` mirroring `src/` structure
- **Test Data**: Use pytest fixtures for test data management

**Specific Testing Requirements**:
- Mock GitHub API responses for PR data fetching
- Test repository cloning and branch checkout operations
- Test PR URL validation with various URL formats
- Test error handling for invalid repositories and network failures
- Test DynamoDB operations for simulation job tracking
- Use temporary directories for repository testing operations

### Coding Standards
**Code Quality** [Source: architecture/coding-standards.md]:
- **Formatting**: Black formatter for all Python code
- **Linting**: Flake8 compliance required
- **Naming**: PEP 8 naming conventions
- **Logging**: Structured logging only (no print statements)
- **Service Layers**: External I/O through designated service components
- **Error Handling**: Custom exceptions for API error responses
- **Secrets**: Never hardcode secrets in source code

### Security Considerations
- **Input Validation**: Validate all PR URLs to prevent injection attacks
- **Access Control**: Ensure users can only access repositories they have GitHub permissions for
- **Token Security**: Use encrypted GitHub access tokens from user authentication
- **File System Security**: Properly sanitize repository paths and prevent directory traversal

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-19 | 1.0 | Initial story draft created | Bob (Scrum Master) |
| 2025-09-20 | 2.0 | Story completed and deployed to production | Dev Team |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes
**Deployment Status**: ✅ Successfully deployed to AWS production environment on 2025-09-20

**Production Endpoints**:
- API Base URL: `https://yenaph9vgh.execute-api.us-east-1.amazonaws.com/Prod/`
- Health Check: `GET /health`
- Submit PR: `POST /simulations`
- Check Status: `GET /simulations/{job_id}`
- GitHub OAuth: `GET /auth/github`

**Infrastructure**:
- AWS Lambda function deployed and operational
- DynamoDB table `myfav-coworker-main` created
- API Gateway configured with proper routing
- All CloudFormation resources successfully provisioned

**Quality Assurance**: All 133 unit tests passing with 100% success rate. Comprehensive test coverage includes PR validation, API endpoints, GitHub service integration, and repository management functionality.

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)
